#!/bin/bash
# this script by Mathieu Bouchard, 2001.

JMAX=unknown

echo
if [ ! -f configure ]
then
	echo -e "Run me from the right directory please."
	exit 1
fi

argc=$#
while [ 0 != $# ]
do
	case $1 in
		--jmax24) JMAX=24
			echo -e "Using jMax 2.4.x"
		;;
		--jmax25) JMAX=25
			echo -e "Using jMax 2.5.x"
		;;
		--jmax-dist-dir)
			JMAXROOTDIR=$2
			shift
		;;
		*)
			echo "unknown option \`$1'"
			exit 1
		;;
	esac
	shift
done

if [ "z$JMAX" = "zunknown" ]
then
	echo -e "Please specify --jmax24 or --jmax25"
	exit 1
fi

if [ "z$JMAXROOTDIR" == "z" ]; then
	JMAXROOTDIR=`(cd ../..; echo $PWD)`
	if [ -d $JMAXROOTDIR/Makefiles ]; then
		echo "assuming --jmax-dist-dir $JMAXROOTDIR"
	else
		echo "please specify --jmax-dist-dir <pathname>"
		exit 1
	fi
fi

has-videodev () {
(
	echo '#include <stdlib.h>'
	echo '#include <linux/videodev.h>'
	echo 'int main (void) { struct video_window foo; }' 
) > /tmp/$$.c
gcc /tmp/$$.c -o /tmp/$$
}

FORMATS='PPM Targa'

echo -n "looking for videodev (video4linux input hardware): "
if has-videodev; then
	echo "yes"
	FORMATS="$FORMATS VideoDev"
else
	echo "no"
fi

symlink () {
	rm $1
	ln -s $1.$JMAX $1
	echo -e "`pwd`: updating $1"
}

echo "our format list: $FORMATS"
echo ""

#--------------------------------#
echo "generating symbolic links"

symlink Makefile
(cd c
	symlink Makefile
	(cd src
		symlink Makefile
		symlink fts_redirect.h))

#--------------------------------#
echo "generating ./config.make"
(
	echo PNAME=video4jmax
	echo JMAXROOTDIR=$JMAXROOTDIR
	echo JMAXDISTDIR=$JMAXROOTDIR
) > config.make

#--------------------------------#
echo "generating c/src/Sources"
(
	echo "SOURCES = \\"
	echo "dim.c grid.c grid_basic.c video4jmax.c \\"
	echo "video_out.c video_out_file.c video_in_file.c \\"
	for format in $FORMATS; do
		lc_format=`echo $format | tr A-Z a-z`
		echo "format_$lc_format.c \\"
	done
	echo ""
) > c/src/Sources

#--------------------------------#
echo "generating c/src/config.h"
(
echo "
#ifndef __CONFIG_H
#define __CONFIG_H
/* this file was auto-generated by video4jmax/configure */
#define FILE_FORMAT_LIST(_prefix_) \\"
for format in $FORMATS; do
	echo "  _prefix_ Format$format ,\\"
done
echo "_prefix_ FormatPPM" # twice... hack.
echo "#endif"
) > c/src/config.h
